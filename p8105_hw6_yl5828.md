p8105_hw6_yl5828
================
Leah Li
2025-12-03

## Problem 0

``` r
library(tidyverse)
library(patchwork)
library(rvest)
library(broom)
library(janitor)


knitr::opts_chunk$set(
    echo = TRUE,
    warning = FALSE,
    fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

``` r
url <- "https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv"

homicide_data <- read_csv(url)
```

``` r
homicide_df <- homicide_data %>%
  mutate(city_state = paste(city, state, sep = ", ")) %>%
  mutate(resolved = as.numeric(disposition == "Closed by arrest")) %>%
  filter(!city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")) %>%
  filter(victim_race %in% c("White", "Black")) %>%
  mutate(victim_age = as.numeric(victim_age)) %>%
  filter(!is.na(victim_age)) %>%
  mutate(
    victim_sex = factor(victim_sex),
    victim_race = factor(victim_race)
  )
```

``` r
baltimore_df <- homicide_df %>%
  filter(city_state == "Baltimore, MD")

baltimore_glm <- glm(
  resolved ~ victim_age + victim_sex + victim_race,
  data = baltimore_df,
  family = binomial()
)

# Tidy the results
baltimore_results <- baltimore_glm %>%
  tidy() %>%
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>%
  filter(term == "victim_sexMale") %>%
  select(term, OR, CI_lower, CI_upper)
```

Baltimore, MD Results:

For Baltimore, the adjusted odds ratio for solving homicides comparing
male victims to female victims is 0.426 with 95% CI: (**0.325**,
**0.558**).

``` r
city_results <- homicide_df %>%
  nest(data = -city_state) %>%
  mutate(
    model = map(data, ~glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial())),
    tidied = map(model, tidy)) %>%
  unnest(tidied) %>%
  filter(term == "victim_sexMale") %>%
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>%
  select(city_state, OR, CI_lower, CI_upper) %>%
  arrange(OR)

city_results
```

    ## # A tibble: 47 × 4
    ##    city_state         OR CI_lower CI_upper
    ##    <chr>           <dbl>    <dbl>    <dbl>
    ##  1 New York, NY    0.262    0.138    0.499
    ##  2 Baton Rouge, LA 0.381    0.209    0.695
    ##  3 Omaha, NE       0.382    0.203    0.721
    ##  4 Cincinnati, OH  0.400    0.236    0.677
    ##  5 Chicago, IL     0.410    0.336    0.501
    ##  6 Long Beach, CA  0.410    0.156    1.08 
    ##  7 San Diego, CA   0.413    0.200    0.855
    ##  8 Baltimore, MD   0.426    0.325    0.558
    ##  9 Pittsburgh, PA  0.431    0.265    0.700
    ## 10 Denver, CO      0.479    0.236    0.971
    ## # ℹ 37 more rows

``` r
plot <- city_results %>%
  mutate(city_state = fct_reorder(city_state, OR)) %>%
  ggplot(aes(x = city_state, y = OR)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper), width = 0.3) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red", alpha = 0.7) +
  coord_flip() +
  labs(
    title = "Adjusted Odds Ratios for Solving Homicides: Male vs Female Victims",
    subtitle = "Adjusted for victim age and race across 47 U.S. cities",
    x = "City",
    y = "Odds Ratio (95% CI)") +
  theme_minimal()

plot
```

<img src="p8105_hw6_yl5828_files/figure-gfm/Create plot-1.png" width="90%" />

In the plot, most cities are clustered close to 1 and most 95% CIs cross
the vertical line at 1, suggesting little evidence of large, consistent
differences in clearance rates by victim sex within most cities. A few
cities have ORs noticeably above 1, hinting that male-victim homicides
might be more likely to be solved there, but their CIs are wide, so
those estimates are fairly imprecise. Overall, there isn’t a strong
pattern by city.

## Problem 2

``` r
library(p8105.datasets)
data("weather_df")
```

``` r
set.seed(1)

n_bootstrap <- 5000

boot_results <- 
  tibble(rep = 1:n_bootstrap) %>%
  mutate(
    sample = map(rep, ~ sample_n(weather_df, size = nrow(weather_df), replace = TRUE)),
    model = map(sample, ~ lm(tmax ~ tmin + prcp, data = .x)),
    glance_output = map(model, glance),
    tidy_output = map(model, tidy),
    r_squared = map_dbl(glance_output, "r.squared"),
    beta1 = map_dbl(tidy_output, ~ .x$estimate[.x$term == "tmin"]),
    beta2 = map_dbl(tidy_output, ~ .x$estimate[.x$term == "prcp"]),
    beta_ratio = beta1 / beta2
  ) %>%
  select(rep, r_squared, beta_ratio)

# Calculate 95% confidence intervals
ci_r_squared <- quantile(boot_results$r_squared, c(0.025, 0.975))
ci_beta_ratio <- quantile(boot_results$beta_ratio, c(0.025, 0.975))

ci_r_squared
```

    ##      2.5%     97.5% 
    ## 0.9343767 0.9466277

``` r
ci_beta_ratio
```

    ##      2.5%     97.5% 
    ## -279.7489 -125.6859

``` r
# Create plot for R-squared distribution
plot_r_squared <- boot_results %>%
  ggplot(aes(x = r_squared)) +
  geom_density(fill = "purple", alpha=0.5) +
  labs(
    title = "Bootstrap Distribution of R²",
    x = "R²",
    y = "Count"
  ) +
  theme_minimal()

# Create plot for beta ratio distribution
plot_beta_ratio <- boot_results %>%
  ggplot(aes(x = beta_ratio)) +
  geom_density(bins = 40, fill = "blue", alpha=0.5)  +
  labs(
    title = "Bootstrap Distribution of β1 / β2",
    x = "β1 / β2 (tmin coefficient / prcp coefficient)",
    y = "Count"
  ) +
  theme_minimal()

plot_r_squared
```

<img src="p8105_hw6_yl5828_files/figure-gfm/distribution plots-1.png" width="90%" />

``` r
plot_beta_ratio
```

<img src="p8105_hw6_yl5828_files/figure-gfm/distribution plots-2.png" width="90%" />

From the plots, we could observe that the bootstrap distribution of R²
is approximately normal with a slight left skew, centered around 0.94,
which indicates the model consistently explains a high proportion of
variance in the data. In contrast, the distribution of the ratio β1 / β2
is heavily left-skewed with a significant tail extending toward more
negative values (ranging down to -400); this asymmetry suggests
instability in the estimate, likely caused by the denominator (the
precipitation coefficient, β2) being very close to zero in certain
bootstrap samples, inflating the ratio.

## Problem 3

``` r
birthweight_raw = read_csv("data/birthweight.csv") |> 
  clean_names()
```

    ## Rows: 4342 Columns: 20
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (20): babysex, bhead, blength, bwt, delwt, fincome, frace, gaweeks, malf...
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
library(p8105.datasets)
data("weather_df")
```

``` r
set.seed(1)
# Bootstrap

boot_results = 
  tibble(rep = 1:5000) |> 
  mutate(
    sample = map(rep, ~ sample_n(weather_df, size = nrow(weather_df), replace = TRUE)),
    model  = map(sample, ~ lm(tmax ~ tmin + prcp, data = .x)),
    glance = map(model, glance),
    tidy   = map(model, tidy),

    r2 = map_dbl(glance, "r.squared"),

    beta1 = map_dbl(tidy, ~ .x$estimate[.x$term == "tmin"]),
    beta2 = map_dbl(tidy, ~ .x$estimate[.x$term == "prcp"]),
    beta_ratio = beta1 / beta2
  ) |> 
  select(rep, r2, beta_ratio)
```

``` r
boot_results |> 
  ggplot(aes(x = r2)) +
  geom_histogram(bins = 40, fill = "#4F46E5", color = "white") +
  theme_minimal() +
  labs(title = "Bootstrap Distribution of R²")
```

<img src="p8105_hw6_yl5828_files/figure-gfm/histogram of r square-1.png" width="90%" />
The bootstrap distribution of r_square is tight, symmetric, and
approximately normal, centered near the observed sample value (around
0.94). This indicates that the model’s explanatory power—how well tmin
and prcp predict tmax—is stable across bootstrap samples. The narrow
spread of the distribution suggests low variability and a high degree of
confidence in the estimated r_square.

``` r
boot_results |> 
  ggplot(aes(x = beta_ratio)) +
  geom_histogram(bins = 40, fill = "#06B6D4", color = "white") +
  theme_minimal() +
  labs(title = "Bootstrap Distribution of β₁ / β₂")
```

<img src="p8105_hw6_yl5828_files/figure-gfm/histogram of beta-1.png" width="90%" />
In contrast, the bootstrap distribution of the ratio is much wider, more
variable, and noticeably right-skewed. This behavior arises because the
denominator (the coefficient for prcp) is small and noisy, so small
changes in the fitted model can produce large swings in the ratio,
including extreme negative values. The wide spread and skewness show
that the ratio is a highly unstable statistic, making bootstrap
inference especially valuable since its sampling distribution is far
from normal and cannot be well described analytically.

``` r
ci_r2 = quantile(boot_results$r2, c(0.025, 0.975))
ci_ratio = quantile(boot_results$beta_ratio, c(0.025, 0.975))

ci_r2
```

    ##      2.5%     97.5% 
    ## 0.9343767 0.9466277

``` r
ci_ratio
```

    ##      2.5%     97.5% 
    ## -279.7489 -125.6859
